---
// HorizontalScroll.astro
---

<div id="scroll-wrapper">
    <section id="section_to-pin" class="section_to-pin">
        <div id="section_pin" class="section_pin">
            <div class="topo-overlay"></div>

            <div class="horizontal-block">
                <div class="first-slide">
                    <div class="mosaic-item main-text">
                        <div class="text">
                            <p>
                                I’m a web-focused software developer who enjoys
                                building products that actually get used. I care
                                about clarity, performance, and making complex
                                things feel simple.
                            </p>
                        </div>
                    </div>

                    <div class="mosaic-item img-primary">
                        <div class="img-frame tall">
                            <img
                                src="https://i.pinimg.com/736x/fb/2a/51/fb2a5109b06d4f734452f7a2c46c753f.jpg"
                            />
                        </div>
                    </div>

                    <div class="mosaic-item img-secondary">
                        <div class="img-frame small">
                            <img
                                src="https://i.pinimg.com/736x/58/f6/b1/58f6b1d6d18922848ca37344e667a435.jpg"
                            />
                        </div>
                    </div>

                    <div class="mosaic-item img-accent">
                        <div class="img-frame small">
                            <img
                                src="https://i.pinimg.com/1200x/e3/f7/0c/e3f70c73b3af31c4126dad6937ed0e35.jpg"
                            />
                        </div>
                    </div>
                </div>
            </div>

            <div class="horizontal-block">
                <div class="second-slide">
                    <div class="mosaic-item img-background">
                        <div class="img-frame wide">
                            <img
                                src="https://i.pinimg.com/1200x/ed/60/38/ed6038d0b6cc93629baf9f481160054b.jpg"
                            />
                        </div>
                    </div>

                    <div class="mosaic-item img-foreground">
                        <div class="img-frame medium">
                            <img
                                src="https://i.pinimg.com/736x/aa/98/26/aa9826359c2ec5d0bfb0add5f6d36a88.jpg"
                            />
                        </div>
                    </div>

                    <div class="mosaic-item secondary-text">
                        <div class="text">
                            <p>
                                Most of my work lives at the intersection of web
                                apps and data. I focus on building systems that
                                are maintainable, scalable, and grounded in real
                                needs.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="horizontal-block">
                <div class="third-slide">
                    <div class="mosaic-item img-top-left">
                        <div class="img-frame small">
                            <img
                                src="https://i.pinimg.com/1200x/3b/39/c7/3b39c758c60ac3846b0fc0626a88a990.jpg"
                            />
                        </div>
                    </div>

                    <div class="mosaic-item final-text">
                        <div class="text">
                            <p>
                                I value clean code, thoughtful UX, and
                                continuous learning over chasing trends. I’m
                                comfortable owning features end to end.
                            </p>
                        </div>
                    </div>

                    <div class="mosaic-item img-main-right">
                        <div class="img-frame tall">
                            <img
                                src="https://i.pinimg.com/1200x/7d/a1/d3/7da1d34709b168ad674b6afb0091b0ca.jpg"
                            />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- <section class="vertical-footer">
        <div class="footer-content">
            <h2>Siguiente Capítulo</h2>
            <p>
                Desliza hacia abajo para continuar con el portfolio tradicional.
            </p>
        </div>
    </section> -->
</div>

<style>
    /* Configuración del Pinning */
    .section_to-pin {
        height: 100vh;
        width: 100%;
        overflow: hidden;
    }

    .section_pin {
        height: 100vh;
        display: flex;
        flex-wrap: nowrap;
        width: auto; /* Cambia de 300vw a auto */
        position: relative;
        /* padding-left: 5vw; */
        gap: 0; /* Asegúrate de que no haya espacio entre bloques */
    }

    /* Capa de fondo con líneas (puedes usar un SVG topográfico real aquí) */
    .topo-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("data:image/svg+xml;base64,..."); /* Insertar SVG aquí */
        opacity: 0.1;
        z-index: 0;
        pointer-events: none;
    }

    /* Bloques de contenido */
    .horizontal-block {
        position: relative;
        width: 100vw; /* Cambia de 100vw a 80vw para que la siguiente sección asome antes */
        height: 100%;
        flex-shrink: 0;
        /* border: 1px solid red; */
        display: flex;
        justify-content: space-around;
        align-items: center;
        gap: 15px;
    }

    .horizontal-block.column {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 15px;
    }

    .horizontal-block.column .img-section {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
    }

    .horizontal-block.column .text-section {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin: 30px;
    }

    .horizontal-block::last-child {
        justify-content: center;
    }

    .first-slide {
        width: 100vw;
        height: 100%;
        display: grid;
        /* Definimos una rejilla de 12 columnas para control total */
        grid-template-columns: repeat(12, 1fr);
        grid-template-rows: repeat(10, 1fr);
        gap: 20px;
        padding: 5vh 5vw;
        box-sizing: border-box;
    }

    /* El texto ocupa el centro-izquierda con mucho peso */
    .first-slide .main-text {
        grid-column: 2 / 7;
        grid-row: 4 / 8;
        z-index: 2;
        display: flex;
        align-items: center;
    }

    .first-slide .main-text p {
        font-size: 2.8rem; /* Más grande para que sea el héroe */
        line-height: 1.1;
        letter-spacing: -1px;
    }

    /* Imagen vertical a la derecha */
    .first-slide .img-primary {
        grid-column: 8 / 11;
        grid-row: 2 / 9;
        display: flex;
        align-items: center;
    }

    .first-slide .img-primary .tall {
        width: 100%;
        height: 80%; /* Ajuste para que no toque bordes */
    }

    /* Imagen pequeña que "flota" arriba a la izquierda */
    .first-slide .img-secondary {
        grid-column: 4 / 6;
        grid-row: 1 / 4;
        opacity: 0.8;
    }

    /* Imagen pequeña abajo que rompe la línea del texto */
    .first-slide .img-accent {
        grid-column: 6 / 8;
        grid-row: 8 / 11;
        transform: translateY(-20px); /* Ligero desfase */
    }

    /* Ajuste de marcos para este slide */
    .first-slide .img-frame {
        margin: 0;
        width: 100%;
        height: 100%;
        box-shadow: 20px 20px 60px rgba(0, 0, 0, 0.05);
    }

    .second-slide {
        width: 100vw;
        height: 100%;
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        grid-template-rows: repeat(10, 1fr);
        gap: 20px;
        padding: 5vh 5vw;
        box-sizing: border-box;
    }

    /* Imagen grande que sirve de ancla */
    .second-slide .img-background {
        grid-column: 6 / 12;
        grid-row: 2 / 7;
        z-index: 1;
    }

    /* Imagen que sobresale y crea profundidad */
    .second-slide .img-foreground {
        grid-column: 2 / 6;
        grid-row: 4 / 9;
        z-index: 3;
        filter: drop-shadow(30px 30px 50px rgba(0, 0, 0, 0.1));
    }

    /* Texto: Alineado a la derecha para equilibrar la imagen de la izquierda */
    .second-slide .secondary-text {
        grid-column: 7 / 11;
        grid-row: 7 / 10;
        z-index: 2;
        display: flex;
        align-items: center;
    }

    .second-slide .secondary-text p {
        font-size: 2.2rem;
        line-height: 1.1;
        text-align: right;
        /* border-right: 6px solid #000; */
        padding-right: 25px;
    }

    /* Ajuste de frames para el segundo slide */
    .second-slide .img-frame {
        margin: 0;
        width: 100%;
        height: 100%;
    }

    .third-slide {
        width: 100vw;
        height: 100%;
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        grid-template-rows: repeat(10, 1fr);
        gap: 20px;
        padding: 5vh 5vw;
        box-sizing: border-box;
    }

    /* Imagen pequeña que flota arriba a la izquierda */
    .third-slide .img-top-left {
        grid-column: 2 / 5;
        grid-row: 2 / 5;
        z-index: 2;
    }

    /* Texto principal: Ocupa el centro-bajo para equilibrar */
    .third-slide .final-text {
        grid-column: 3 / 8;
        grid-row: 6 / 10;
        z-index: 3;
        display: flex;
        align-items: center;
    }

    .third-slide .final-text p {
        font-size: 2.5rem;
        line-height: 1.1;
        letter-spacing: -1px;
        font-weight: 700;
        /* Estética similar al slide 1 */
        /* border-left: 8px solid #000; */
        padding-left: 25px;
    }

    /* Imagen principal vertical que domina la derecha */
    .third-slide .img-main-right {
        grid-column: 8 / 12;
        grid-row: 2 / 9;
        z-index: 1;
    }

    .third-slide .img-main-right .tall {
        width: 100%;
        height: 100%;
        box-shadow: 30px 30px 80px rgba(0, 0, 0, 0.1);
    }

    /* Coherencia con los frames anteriores */
    .third-slide .img-frame {
        margin: 0;
        width: 100%;
        height: 100%;
    }

    .mosaic-item {
        /*border: 1px solid blue;*/
    }

    /* Marcos de Imagen */
    .img-frame {
        overflow: hidden;
        transition: transform 0.3s ease;
        margin: 15px;
    }
    .img-frame img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 5px;
    }

    .text p {
        font-family: "Open Sans", sans-serif;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1;
    }

    /* Tamaños */
    .small {
        width: 18vw;
        height: 30vh;
        border-radius: 5px;
    }
    .medium {
        width: 25vw;
        height: 45vh;
        border-radius: 5px;
    }
    .large {
        width: 35vw;
        height: 60vh;
        border-radius: 5px;
    }
    .wide {
        width: 45vw;
        height: 35vh;
        border-radius: 5px;
    }
    .tall {
        width: 22vw;
        height: 55vh;
        border-radius: 5px;
    }

    /* Footer vertical */
    .vertical-footer {
        height: 100vh;
        background: #fff;
        display: flex;
        align-items: start;
        justify-content: center;
        position: relative;
        z-index: 10;
    }

    @media (max-width: 768px) {
        /* Permitir que la sección crezca verticalmente */
        .section_to-pin {
            height: auto;
            overflow: visible;
        }

        /* Convertir el flex horizontal en una columna vertical */
        .section_pin {
            flex-direction: column;
            height: auto;
            width: 100% !important;
            /* padding: 20px; */
            transform: none !important; /* Anula el movimiento de GSAP en móvil */
        }

        /* Hacer que los bloques ocupen el ancho total */
        .horizontal-block {
            width: 100%;
            flex-direction: column;
            height: auto;
            gap: 40px;
            margin-bottom: 50px;
        }

        /* Ajustar los tamaños de imagen para que no se vean pequeñas */
        .small,
        .medium,
        .large,
        .wide,
        .tall {
            width: 100% !important;
            height: auto !important;
            aspect-ratio: 4 / 3; /* O el que prefieras para mantener consistencia */
        }

        /* Ajustar el texto para que sea legible */
        .text p {
            font-size: 1.2rem;
            line-height: 1.4;
            text-align: left;
        }

        /* Reajustar la sección de columna interna */
        .horizontal-block.column .img-section {
            flex-direction: column;
            width: 100%;
        }
    }

    @media (max-width: 768px) {
        /* 1. Liberamos el contenedor */
        .section_to-pin {
            height: auto !important;
            overflow: visible !important;
        }

        .section_pin {
            display: block !important; /* Adiós al flex horizontal */
            width: 100% !important;
            height: auto !important;
            transform: none !important; /* Forzamos que no haya traslación de GSAP */
        }

        /* 2. Ajustamos los slides a vertical */
        .first-slide,
        .second-slide,
        .third-slide {
            width: 100% !important;
            height: auto !important;
            display: flex !important; /* En móvil, flex es más predecible para apilar */
            flex-direction: column;
            padding: 60px 25px; /* Más aire entre secciones */
            gap: 30px;
        }

        /* 3. Estilo de las imágenes en móvil */
        .mosaic-item {
            width: 100% !important;
            transform: none !important;
        }

        .img-frame {
            width: 100% !important;
            height: auto !important;
            aspect-ratio: 4 / 5; /* Proporción elegante para móvil */
            margin: 0 !important;
        }

        /* 4. Jerarquía de textos en móvil */
        .first-slide .main-text p,
        .second-slide .secondary-text p,
        .third-slide .final-text p {
            font-size: 1.8rem !important;
            text-align: left !important;
            border: none !important;
            padding: 0 !important;
            line-height: 1.2;
        }

        /* 5. Detalles específicos para mantener el estilo "collage" */
        .img-secondary,
        .img-top-left {
            width: 60% !important; /* Unas más pequeñas que otras */
            align-self: flex-end;
        }

        .img-foreground {
            width: 85% !important;
            margin-top: -50px !important; /* Solapamiento visual también en móvil */
            z-index: 10;
        }
    }
</style>

<script>
    import gsap from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";
    import Lenis from "@studio-freight/lenis";

    gsap.registerPlugin(ScrollTrigger);

    function init() {
        const lenis = new Lenis({
            lerp: 0.1,
            smoothWheel: true,
        });

        lenis.on("scroll", ScrollTrigger.update);
        gsap.ticker.add((time) => lenis.raf(time * 1000));

        const sectionPin = document.querySelector("#section_pin");
        const sectionToPin = document.querySelector("#section_to-pin");

        if (sectionPin && sectionToPin) {
            // Creamos un contexto de GSAP que solo se activa en pantallas > 768px
            let mm = gsap.matchMedia();

            mm.add("(min-width: 769px)", () => {
                // Este código SOLO se ejecuta en Desktop
                const getScrollAmount = () =>
                    -(sectionPin.scrollWidth - window.innerWidth);

                gsap.to(sectionPin, {
                    x: getScrollAmount,
                    ease: "none",
                    scrollTrigger: {
                        trigger: sectionToPin,
                        pin: true,
                        scrub: 1,
                        start: "top top",
                        end: () => `+=${sectionPin.scrollWidth}`,
                        invalidateOnRefresh: true,
                    },
                });
            });

            // En pantallas menores a 768px, ScrollTrigger no hará el pin ni el movimiento horizontal
        }
    }

    // En Astro, 'load' es más seguro que 'DOMContentLoaded' para GSAP
    // porque espera a que las imágenes y el CSS definan los anchos.
    window.addEventListener("load", () => {
        // Un pequeño delay extra asegura que el layout esté asentado
        setTimeout(init, 100);
    });
</script>
